CREATE OR REPLACE PROCEDURE COIN_Get
AS
   COIN_ID VARCHAR(20); --회원아이디
   COIN_Name VARCHAR(20); --코인이름
   COIN_JDK VARCHAR(20); --거리소명
   COIN_DN INT; --개발자번호
   COIN_Num INT; --보유개수
   COIN_ID2 VARCHAR(20); --회원아이디
   COIN_Name2 VARCHAR(20); --코인이름
   COIN_JDK2 VARCHAR(20); --거리소명
   COIN_DN2 INT; --개발자번호
   COIN_Num2 INT; --보유개수
   n INT;
 
   CURSOR C IS SELECT 회원아이디, 코인이름, 거래소명, 개발자번호, SUM(매매수량) FROM 매매내역 group by 회원아이디, 코인이름, 거래소명, 개발자번호;

BEGIN
   OPEN C;
   LOOP
      n:=0;
      FETCH C INTO COIN_ID, COIN_Name, COIN_JDK, COIN_DN, COIN_Num;
      EXIT WHEN C%NOTFOUND;
      BEGIN
	SELECT 회원아이디, 코인이름, 거래소명, 개발자번호 INTO COIN_ID2, COIN_Name2, COIN_JDK2, COIN_DN2 FROM 보유코인 WHERE 회원아이디=COIN_ID AND 코인이름=COIN_Name AND 거래소명=COIN_JDK AND 개발자번호=COIN_DN;
		EXCEPTION
		   WHEN NO_DATA_FOUND THEN
		   BEGIN
		      COIN_ID2:=NULL;
		      COIN_Name2:=NULL;
		      COIN_JDK2:=NULL;
		      COIN_DN2:=NULL;
		   END;
		IF(COIN_ID2=COIN_ID AND COIN_Name2=COIN_Name AND COIN_JDK2=COIN_JDK AND COIN_DN2=COIN_DN) THEN
		BEGIN
		   UPDATE 보유코인 SET 보유개수=COIN_Num WHERE 회원아이디=COIN_ID AND 코인이름=COIN_Name AND 거래소명=COIN_JDK AND 개발자번호=COIN_DN;
		   n:=n+1;
		END;
		END IF;
	     IF n=0 THEN
		INSERT INTO 보유코인 VALUES(COIN_ID, COIN_Name, COIN_JDK, COIN_DN, COIN_Num);
	     END IF;
	END;
   END LOOP;
   CLOSE C;
END;